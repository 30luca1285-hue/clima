<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¡ï¸ Stazione Meteo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:      #0f172a;
      --card:    #1e293b;
      --border:  #334155;
      --text:    #f1f5f9;
      --muted:   #94a3b8;
      --accent:  #3b82f6;
      --hot:     #ef4444;
      --cold:    #60a5fa;
      --green:   #22c55e;
      --orange:  #f97316;
      --purple:  #a855f7;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; min-height: 100vh; }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 32px;
      flex-wrap: wrap;
    }
    .header-title { font-size: 1rem; font-weight: 700; color: var(--accent); }
    .live-block { display: flex; align-items: baseline; gap: 12px; }
    .live-temp { font-size: 2.8rem; font-weight: 800; line-height: 1; }
    .live-hum  { font-size: 1.4rem; font-weight: 600; color: var(--cold); }
    .live-meta { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .header-spacer { flex: 1; }
    .update-badge { font-size: 0.72rem; color: var(--muted); text-align: right; }

    /* â”€â”€ NAV â”€â”€ */
    .nav {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 4px;
      padding: 10px 24px;
      overflow-x: auto;
    }
    .nav button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 7px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
      transition: all .15s;
    }
    .nav button.active, .nav button:hover { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* â”€â”€ SECTIONS â”€â”€ */
    .section { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }
    .section.active { display: block; }

    /* â”€â”€ CARD â”€â”€ */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .card-title { font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 14px; }

    /* â”€â”€ CHART â”€â”€ */
    .chart-wrap { position: relative; }
    .chart-wrap.h260 { height: 260px; }
    .chart-wrap.h340 { height: 340px; }
    .chart-wrap.h420 { height: 420px; }

    /* â”€â”€ STATS GRID â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 10px; text-align: center; }
    .stat-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; margin-bottom: 6px; }
    .stat-val { font-size: 1.6rem; font-weight: 800; }
    .hot   { color: var(--hot); }
    .cold  { color: var(--cold); }
    .green { color: var(--green); }
    .orange { color: var(--orange); }

    /* â”€â”€ SELECTORS â”€â”€ */
    .selector { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 18px; }
    .sel-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.82rem;
      transition: all .15s;
    }
    .sel-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 600; }

    /* â”€â”€ YEAR TABLE (panoramica) â”€â”€ */
    .yr-table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th { background: #0f172a; color: var(--muted); font-weight: 600; padding: 8px 10px; text-align: right; white-space: nowrap; }
    th:first-child { text-align: left; }
    td { padding: 7px 10px; text-align: right; border-top: 1px solid #1e293b; }
    td:first-child { text-align: left; font-weight: 600; color: var(--muted); }
    tr:hover td { background: #1e293b80; }
    .td-hot  { color: var(--hot);   font-weight: 700; }
    .td-cold { color: var(--cold);  font-weight: 700; }
    .td-live { color: var(--green); font-style: italic; }
    .td-rain { color: var(--cold); }

    /* â”€â”€ SYNC DOT â”€â”€ */
    .sync-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
    .sync-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .sync-red   { background: var(--hot);   box-shadow: 0 0 6px var(--hot); }

    /* â”€â”€ PERIOD PICKER â”€â”€ */
    .period-picker { display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-start; }
    .period-inputs { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .period-label  { font-size: 0.82rem; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    input[type="date"] {
      background: var(--bg); border: 1px solid var(--border); color: var(--text);
      padding: 6px 12px; border-radius: 8px; font-size: 0.82rem; cursor: pointer; }
    input[type="date"]:focus { outline: none; border-color: var(--accent); }

    /* â”€â”€ LOADING â”€â”€ */
    .loading { text-align: center; padding: 80px; color: var(--muted); }
    .loading-spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ EMPTY STATE â”€â”€ */
    .empty { text-align: center; padding: 60px 20px; color: var(--muted); font-size: 0.9rem; }

    @media (max-width: 600px) {
      .header { padding: 12px 16px; gap: 16px; }
      .live-temp { font-size: 2rem; }
      .section { padding: 12px; }
    }
  </style>
</head>
<body>

<!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="header">
  <div>
    <div class="header-title">ğŸŒ¡ï¸ Stazione Meteo <span style="font-size:0.65rem;font-weight:400;color:var(--muted);margin-left:6px">v06</span></div>
    <div class="live-meta" id="hdr-sync" style="display:none"><span class="sync-dot" id="sync-dot"></span><span id="sync-text"></span></div>
  </div>
  <div class="live-block">
    <div class="live-temp" id="hdr-t">â€”</div>
    <div>
      <div class="live-hum" id="hdr-h">â€” %</div>
      <div class="live-meta" id="hdr-ts"></div>
    </div>
  </div>
  <div class="header-spacer"></div>
  <div class="update-badge" id="hdr-update"></div>
</div>

<!-- â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="nav">
  <button class="active" onclick="nav('panoramica',this)">Panoramica</button>
  <button onclick="nav('anno',this)">Per Anno</button>
  <button onclick="nav('periodo',this)">Periodo</button>
  <button onclick="nav('giornaliero',this)">Giornaliero</button>
</div>

<!-- â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loading" class="loading">
  <div class="loading-spinner"></div>
  Caricamento dati...
</div>

<!-- â•â• PANORAMICA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-panoramica" class="section">
  <div class="stats-grid" id="stats-grid"></div>
  <div class="card">
    <div class="card-title">Temperatura media mensile â€” tutti gli anni</div>
    <div class="chart-wrap h420"><canvas id="c-overview"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Pioggia totale annuale (mm)</div>
    <div class="chart-wrap h260"><canvas id="c-rain-yr"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Tabella riepilogativa â€” medie annuali</div>
    <div class="yr-table-wrap"><table id="tbl-annual"></table></div>
  </div>
</div>

<!-- â•â• PER ANNO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-anno" class="section">
  <div class="selector" id="year-sel"></div>
  <div class="card">
    <div class="card-title">Temperatura mensile â€” <span id="yr-label">â€”</span></div>
    <div class="chart-wrap h420"><canvas id="c-anno-temp"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">UmiditÃ  mensile</div>
    <div class="chart-wrap h260"><canvas id="c-anno-hum"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Pioggia mensile (mm)</div>
    <div class="chart-wrap h260"><canvas id="c-anno-rain"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Punto di rugiada mensile (Â°C)</div>
    <div class="chart-wrap h260"><canvas id="c-anno-rd"></canvas></div>
  </div>
</div>

<!-- â•â• PERIODO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-periodo" class="section">
  <div class="card" style="margin-bottom:20px">
    <div class="period-picker">
      <div id="period-presets" class="selector" style="margin:0">
        <button class="sel-btn" data-days="1" onclick="setPeriod(1,this)">Oggi</button>
        <button class="sel-btn active" data-days="3" onclick="setPeriod(3,this)">3 giorni</button>
        <button class="sel-btn" data-days="7" onclick="setPeriod(7,this)">7 giorni</button>
        <button class="sel-btn" data-days="30" onclick="setPeriod(30,this)">30 giorni</button>
      </div>
      <div class="period-inputs">
        <label class="period-label">Da <input type="date" id="p-from" onchange="customPeriod()"></label>
        <label class="period-label">A &nbsp;<input type="date" id="p-to"   onchange="customPeriod()"></label>
      </div>
    </div>
  </div>
  <div id="periodo-empty" class="empty" style="display:none">
    Nessun dato nel periodo selezionato.
  </div>
  <div id="periodo-charts" style="display:none">
    <div class="card">
      <div class="card-title">Temperatura â€” ogni 30 min (Â°C)</div>
      <div class="chart-wrap h340"><canvas id="c-periodo-temp"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">UmiditÃ  â€” ogni 30 min (%)</div>
      <div class="chart-wrap h260"><canvas id="c-periodo-hum"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Punto di rugiada â€” ogni 30 min (Â°C)</div>
      <div class="chart-wrap h260"><canvas id="c-periodo-rd"></canvas></div>
    </div>
  </div>
</div>

<!-- â•â• GIORNALIERO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-giornaliero" class="section">
  <div id="daily-empty" class="empty" style="display:none">
    Nessun dato giornaliero ancora â€” i dati si accumulano dal momento in cui il trigger Ã¨ attivo.
  </div>
  <div id="daily-charts">
    <div class="card">
      <div class="card-title">Temperatura giornaliera Min / Media / Max (Â°C)</div>
      <div class="chart-wrap h420"><canvas id="c-daily-temp"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">UmiditÃ  giornaliera Min / Media / Max (%)</div>
      <div class="chart-wrap h260"><canvas id="c-daily-hum"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title">Punto di rugiada giornaliero Min / Media / Max (Â°C)</div>
      <div class="chart-wrap h260"><canvas id="c-daily-rd"></canvas></div>
    </div>
    <div class="card" id="daily-rain-card" style="display:none">
      <div class="card-title">Pioggia giornaliera (mm)</div>
      <div class="chart-wrap h260"><canvas id="c-daily-rain"></canvas></div>
    </div>
  </div>
</div>

<script>
// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘  CONFIG â€” inserisci l'URL del tuo Apps Script web app   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'https://script.google.com/macros/s/AKfycbzl8r8hzoZMs0n0gslLyIdYRN0Q3oF7CnjSqsIuFlycqSquisPJmsyoUQ8QFBzPQFYF/exec';

// â”€â”€ COSTANTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MESI  = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
const MESI_F= ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno',
               'Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
const PALETTE = ['#3b82f6','#22c55e','#f97316','#ef4444','#a855f7','#06b6d4','#eab308','#ec4899'];
const CHART_DEFAULTS = {
  responsive: true,
  maintainAspectRatio: false,
  interaction: { mode: 'index', intersect: false },
  plugins: { legend: { labels: { color: '#94a3b8', boxWidth: 16, font: { size: 11 } } } },
};
const AXIS = {
  x: (extra={}) => ({ ticks: { color: '#94a3b8', ...extra.xticks }, grid: { color: '#334155' }, ...extra.x }),
  y: (sfx='', extra={}) => ({ ticks: { color: '#94a3b8', callback: v => v + sfx, ...extra.yticks }, grid: { color: '#334155' }, ...extra.y }),
};

let D = null;        // dati globali
let CY = null;       // anno selezionato
let charts = {};
let rendered = {};   // sezioni giÃ  renderizzate

// â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function load() {
  try {
    const res = await fetch(API + '?action=getData');
    D = await res.json();
    init();
  } catch(e) {
    document.getElementById('loading').innerHTML =
      '<p style="color:#ef4444">Errore caricamento dati:<br>' + e.message + '</p>';
  }
}

function init() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('s-panoramica').classList.add('active');

  // Header
  if (D.attuale) {
    const t = D.attuale.t, h = D.attuale.h, ts = new Date(D.attuale.ts);
    document.getElementById('hdr-t').textContent  = t.toFixed(1) + ' Â°C';
    document.getElementById('hdr-h').textContent  = h.toFixed(0) + ' %';
    document.getElementById('hdr-ts').textContent = ts.toLocaleString('it-IT');
    document.getElementById('hdr-t').style.color =
      t >= 30 ? 'var(--hot)' : t <= 5 ? 'var(--cold)' : 'var(--text)';
  }
  document.getElementById('hdr-update').textContent =
    'Aggiornato: ' + new Date(D.aggiornato).toLocaleTimeString('it-IT');

  updateSyncStatus();
  buildYearSelector();        // prepara CY e i bottoni anno
  renderPanoramica();         // sezione giÃ  visibile â†’ dimensioni corrette
  rendered['panoramica'] = true;
}

function updateSyncStatus() {
  const el  = document.getElementById('hdr-sync');
  const dot = document.getElementById('sync-dot');
  const txt = document.getElementById('sync-text');
  el.style.display = '';
  if (!D.attuale) {
    dot.className   = 'sync-dot sync-red';
    txt.textContent = 'Nessun dato live';
    return;
  }
  const ageMin = (Date.now() - new Date(D.attuale.ts).getTime()) / 60000;
  const ok = ageMin < 35;
  dot.className   = 'sync-dot ' + (ok ? 'sync-green' : 'sync-red');
  txt.textContent = ok ? 'Sincronizzato' : 'Non sincronizzato';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANORAMICA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPanoramica() {
  const anni = anniSorted();
  renderStatsGrid(anni);
  renderOverviewChart(anni);
  renderRainYrChart(anni);
  renderAnnualTable(anni);
}

function anniSorted() {
  return Object.keys(D.mensile).map(Number).sort((a,b) => a - b);
}

function renderStatsGrid(anni) {
  let allTMin=[], allTMax=[], allTMed=[], allPio=[];
  anni.forEach(yr => {
    Object.values(D.mensile[yr]).forEach(m => {
      if (m.tMin   !== null) allTMin.push(m.tMin);
      if (m.tMax   !== null) allTMax.push(m.tMax);
      if (m.tMedia !== null) allTMed.push(m.tMedia);
      if (m.pioggia!== null) allPio.push(m.pioggia);
    });
  });
  const avg = a => a.reduce((s,v)=>s+v,0)/a.length;
  const stats = [
    { label:'Minima assoluta',  val: Math.min(...allTMin).toFixed(1)+'Â°C', cls:'cold'   },
    { label:'Massima assoluta', val: Math.max(...allTMax).toFixed(1)+'Â°C', cls:'hot'    },
    { label:'Media generale',   val: avg(allTMed).toFixed(1)+'Â°C',         cls:'green'  },
    { label:'Anni di dati',     val: anni.length,                           cls:'orange' },
    ...(allPio.length ? [{ label:'Pioggia tot.', val: allPio.reduce((a,b)=>a+b,0).toFixed(0)+' mm', cls:'cold' }] : []),
    ...(D.giornaliero.length ? [{ label:'Giorni live', val: D.giornaliero.length, cls:'' }] : []),
  ];
  document.getElementById('stats-grid').innerHTML = stats.map(s =>
    `<div class="stat"><div class="stat-label">${s.label}</div><div class="stat-val ${s.cls}">${s.val}</div></div>`
  ).join('');
}

function renderOverviewChart(anni) {
  const datasets = anni.map((yr,i) => ({
    label: String(yr),
    data: MESI.map((_,m) => { const s=D.mensile[yr][m]; return s&&s.tMedia!==null?s.tMedia:null; }),
    borderColor: PALETTE[i%PALETTE.length],
    backgroundColor: PALETTE[i%PALETTE.length]+'25',
    borderWidth: yr===new Date().getFullYear() ? 3 : 1.8,
    pointRadius: 3, tension: 0.35, spanGaps: true,
  }));
  mkChart('c-overview','line',{ labels: MESI, datasets },{
    ...CHART_DEFAULTS,
    scales: { x: AXIS.x(), y: AXIS.y('Â°') },
  });
}

function renderRainYrChart(anni) {
  const totals = anni.map(yr =>
    Object.values(D.mensile[yr]).reduce((s,m) => s + (m.pioggia||0), 0)
  );
  if (totals.every(v=>v===0)) return;
  mkChart('c-rain-yr','bar',{
    labels: anni.map(String),
    datasets:[{ label:'Pioggia mm', data:totals,
      backgroundColor:'#60a5fa55', borderColor:'#60a5fa', borderWidth:1.5, borderRadius:5 }],
  },{
    ...CHART_DEFAULTS,
    plugins:{ legend:{display:false} },
    scales:{ x:AXIS.x(), y:AXIS.y(' mm') },
  });
}

function renderAnnualTable(anni) {
  const hd = ['Anno','T.min Â°C','T.med Â°C','T.max Â°C','U.min %','U.med %','U.max %','Pioggia mm','RD.med Â°C'];
  let html = '<tr>' + hd.map(h=>`<th>${h}</th>`).join('') + '</tr>';
  [...anni].reverse().forEach(yr => {
    const vals = D.mensile[yr];
    const allM = Object.values(vals).filter(m=>m.tMin!==null);
    if (!allM.length) return;
    const f = v => v!==null ? (typeof v==='number'?v.toFixed(1):'â€”') : 'â€”';
    const tMin  = Math.min(...allM.map(m=>m.tMin));
    const tMax  = Math.max(...allM.map(m=>m.tMax));
    const tMed  = allM.reduce((s,m)=>s+m.tMedia,0)/allM.length;
    const hMin  = Math.min(...allM.map(m=>m.hMin));
    const hMax  = Math.max(...allM.map(m=>m.hMax));
    const hMed  = allM.reduce((s,m)=>s+m.hMedia,0)/allM.length;
    const pio   = allM.reduce((s,m)=>s+(m.pioggia||0),0);
    const rdM   = allM.filter(m=>m.rdMedia!==null);
    const rdMed = rdM.length ? rdM.reduce((s,m)=>s+m.rdMedia,0)/rdM.length : null;
    const hasLive = Object.values(vals).some(m=>m.fonte==='live');
    html += `<tr>
      <td>${yr}${hasLive?' <small style="color:var(--green)">âŸ³</small>':''}</td>
      <td class="td-cold">${f(tMin)}</td>
      <td>${f(tMed)}</td>
      <td class="td-hot">${f(tMax)}</td>
      <td>${f(hMin)}</td><td>${f(hMed)}</td><td>${f(hMax)}</td>
      <td class="td-rain">${pio>0?pio.toFixed(0):'â€”'}</td>
      <td style="color:var(--purple)">${rdMed!==null?rdMed.toFixed(1):'â€”'}</td>
    </tr>`;
  });
  document.getElementById('tbl-annual').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PER ANNO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildYearSelector() {
  const anni = anniSorted().reverse();
  CY = anni[0];
  const el = document.getElementById('year-sel');
  el.innerHTML = anni.map((yr,i) =>
    `<button class="sel-btn${i===0?' active':''}" onclick="selectYear(${yr},this)">${yr}</button>`
  ).join('');
}

function selectYear(yr, btn) {
  CY = yr;
  document.querySelectorAll('#year-sel .sel-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderAnno();
}

function renderAnno() {
  const yr = CY, m = D.mensile[yr]||{};
  document.getElementById('yr-label').textContent = yr;

  const tMin  = MESI_F.map((_,i) => m[i]?m[i].tMin  :null);
  const tMed  = MESI_F.map((_,i) => m[i]?m[i].tMedia:null);
  const tMax  = MESI_F.map((_,i) => m[i]?m[i].tMax  :null);
  const hMin  = MESI_F.map((_,i) => m[i]?m[i].hMin  :null);
  const hMed  = MESI_F.map((_,i) => m[i]?m[i].hMedia:null);
  const hMax  = MESI_F.map((_,i) => m[i]?m[i].hMax  :null);
  const pio   = MESI_F.map((_,i) => m[i]&&m[i].pioggia!==null?m[i].pioggia:0);

  // Temperatura: barre min+max + linea media
  mkChart('c-anno-temp','bar',{ labels:MESI_F, datasets:[
    { label:'T.min', data:tMin, backgroundColor:'#60a5fa50', borderColor:'#60a5fa', borderWidth:1.5, borderRadius:4, order:2 },
    { label:'T.media', data:tMed, type:'line', borderColor:'#f97316', backgroundColor:'transparent', borderWidth:2.5, pointRadius:5, pointBackgroundColor:'#f97316', tension:0.3, spanGaps:true, order:1 },
    { label:'T.max', data:tMax, backgroundColor:'#ef444450', borderColor:'#ef4444', borderWidth:1.5, borderRadius:4, order:2 },
  ]},{
    ...CHART_DEFAULTS,
    scales: { x:AXIS.x(), y:AXIS.y('Â°') },
  });

  // UmiditÃ 
  mkChart('c-anno-hum','line',{ labels:MESI_F, datasets:[
    { label:'U.max',   data:hMax, borderColor:'#94a3b870', fill:'+1', borderDash:[4,4], borderWidth:1.2, pointRadius:0, tension:0.3, spanGaps:true },
    { label:'U.media', data:hMed, borderColor:'#22c55e', backgroundColor:'#22c55e18', fill:false, borderWidth:2.5, pointRadius:4, tension:0.3, spanGaps:true },
    { label:'U.min',   data:hMin, borderColor:'#94a3b870', fill:false, borderDash:[4,4], borderWidth:1.2, pointRadius:0, tension:0.3, spanGaps:true },
  ]},{
    ...CHART_DEFAULTS,
    scales:{ x:AXIS.x(), y:AXIS.y('%',{y:{min:0,max:100}}) },
  });

  // Pioggia
  mkChart('c-anno-rain','bar',{ labels:MESI_F, datasets:[
    { label:'Pioggia mm', data:pio, backgroundColor:'#60a5fa55', borderColor:'#60a5fa', borderWidth:1.5, borderRadius:5 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{display:false} },
    scales:{ x:AXIS.x(), y:AXIS.y(' mm') },
  });

  // Punto di rugiada
  const rdMin  = MESI_F.map((_,i) => m[i]?m[i].rdMin :null);
  const rdMed  = MESI_F.map((_,i) => m[i]?m[i].rdMedia:null);
  const rdMax  = MESI_F.map((_,i) => m[i]?m[i].rdMax :null);
  mkChart('c-anno-rd','line',{ labels:MESI_F, datasets:[
    { label:'RD.max',   data:rdMax, borderColor:'#a855f760', backgroundColor:'#a855f712', fill:'+1', borderDash:[4,4], borderWidth:1.2, pointRadius:0, tension:0.3, spanGaps:true },
    { label:'RD.media', data:rdMed, borderColor:'#a855f7',   backgroundColor:'transparent', fill:false, borderWidth:2.5, pointRadius:4, pointBackgroundColor:'#a855f7', tension:0.3, spanGaps:true },
    { label:'RD.min',   data:rdMin, borderColor:'#a855f760', fill:false, borderDash:[4,4], borderWidth:1.2, pointRadius:0, tension:0.3, spanGaps:true },
  ]},{
    ...CHART_DEFAULTS,
    scales:{ x:AXIS.x(), y:AXIS.y('Â°') },
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERIODO â€” raw 30-min su range date personalizzato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function dewPt(t, h) {
  const a = 17.27, b = 237.3;
  const alpha = (a * t / (b + t)) + Math.log(h / 100);
  return +(b * alpha / (a - alpha)).toFixed(2);
}

function setPeriod(days, btn) {
  document.querySelectorAll('#period-presets .sel-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const to   = new Date();
  const from = new Date();
  from.setDate(from.getDate() - (days - 1));
  document.getElementById('p-from').value = from.toISOString().slice(0, 10);
  document.getElementById('p-to').value   = to.toISOString().slice(0, 10);
  renderPeriodo();
}

function customPeriod() {
  document.querySelectorAll('#period-presets .sel-btn').forEach(b => b.classList.remove('active'));
  renderPeriodo();
}

function renderPeriodo() {
  const rawAll  = D.raw || [];
  const fromVal = document.getElementById('p-from').value;
  const toVal   = document.getElementById('p-to').value;
  const fromMs  = fromVal ? new Date(fromVal + 'T00:00:00').getTime() : 0;
  const toMs    = toVal   ? new Date(toVal   + 'T23:59:59').getTime() : Infinity;
  const data    = rawAll.filter(r => r.ts >= fromMs && r.ts <= toMs);

  const empty  = document.getElementById('periodo-empty');
  const charts = document.getElementById('periodo-charts');
  if (!data.length) { empty.style.display = ''; charts.style.display = 'none'; return; }
  empty.style.display = 'none'; charts.style.display = '';

  const labels = data.map(r => {
    const d  = new Date(r.ts);
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const HH = String(d.getHours()).padStart(2,'0');
    const MM = String(d.getMinutes()).padStart(2,'0');
    return dd+'/'+mm+' '+HH+':'+MM;
  });

  mkChart('c-periodo-temp','line',{ labels, datasets:[
    { label:'Temperatura Â°C', data:data.map(r=>r.t),
      borderColor:'#f97316', backgroundColor:'#f9731618',
      fill:true, tension:0.2, pointRadius:0, borderWidth:1.8 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}},
      tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.parsed.y.toFixed(1)+'Â°C'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('Â°') },
  });

  mkChart('c-periodo-hum','line',{ labels, datasets:[
    { label:'UmiditÃ  %', data:data.map(r=>r.h),
      borderColor:'#22c55e', backgroundColor:'#22c55e18',
      fill:true, tension:0.2, pointRadius:0, borderWidth:1.8 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('%',{y:{min:0,max:100}}) },
  });

  mkChart('c-periodo-rd','line',{ labels, datasets:[
    { label:'Punto di rugiada Â°C', data:data.map(r=>dewPt(r.t,r.h)),
      borderColor:'#a855f7', backgroundColor:'#a855f718',
      fill:true, tension:0.2, pointRadius:0, borderWidth:1.8 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}},
      tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.parsed.y.toFixed(1)+'Â°C'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('Â°') },
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GIORNALIERO â€” aggregati per giorno (T, umiditÃ , rugiada, pioggia)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGiornaliero() {
  const gior = D.giornaliero || [];
  const empty  = document.getElementById('daily-empty');
  const charts = document.getElementById('daily-charts');
  if (!gior.length) { empty.style.display = ''; charts.style.display = 'none'; return; }
  empty.style.display = 'none'; charts.style.display = '';

  const labels = gior.map(d => {
    const [, m, dd] = d.data.split('-');
    return dd + '/' + m;
  });

  // Temperatura
  mkChart('c-daily-temp','line',{ labels, datasets:[
    { label:'T.max',   data:gior.map(d=>d.tMax),
      borderColor:'#ef444490', backgroundColor:'#ef444415', fill:'+1', tension:0.3, pointRadius:0, borderWidth:1.5 },
    { label:'T.media', data:gior.map(d=>d.tMedia),
      borderColor:'#f97316', fill:false, tension:0.3, pointRadius:0, borderWidth:2.5 },
    { label:'T.min',   data:gior.map(d=>d.tMin),
      borderColor:'#60a5fa90', backgroundColor:'#60a5fa15', fill:false, tension:0.3, pointRadius:0, borderWidth:1.5 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}},
      tooltip:{callbacks:{label:ctx=>ctx.dataset.label+': '+ctx.parsed.y.toFixed(1)+'Â°C'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('Â°') },
  });

  // UmiditÃ 
  mkChart('c-daily-hum','line',{ labels, datasets:[
    { label:'U.max',   data:gior.map(d=>d.hMax),
      borderColor:'#94a3b860', backgroundColor:'#22c55e10', fill:'+1', tension:0.3, pointRadius:0, borderWidth:1 },
    { label:'U.media', data:gior.map(d=>d.hMedia),
      borderColor:'#22c55e', fill:false, tension:0.3, pointRadius:0, borderWidth:2.5 },
    { label:'U.min',   data:gior.map(d=>d.hMin),
      borderColor:'#94a3b860', fill:false, tension:0.3, pointRadius:0, borderWidth:1 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('%',{y:{min:0,max:100}}) },
  });

  // Punto di rugiada
  mkChart('c-daily-rd','line',{ labels, datasets:[
    { label:'RD.max',   data:gior.map(d=>d.rdMax),
      borderColor:'#a855f760', fill:'+1', borderDash:[4,4], tension:0.3, pointRadius:0, borderWidth:1 },
    { label:'RD.media', data:gior.map(d=>d.rdMedia),
      borderColor:'#a855f7', backgroundColor:'#a855f712', fill:false, tension:0.3, pointRadius:0, borderWidth:2 },
    { label:'RD.min',   data:gior.map(d=>d.rdMin),
      borderColor:'#a855f760', fill:false, borderDash:[4,4], tension:0.3, pointRadius:0, borderWidth:1 },
  ]},{
    ...CHART_DEFAULTS,
    plugins:{ legend:{labels:{color:'#94a3b8'}} },
    scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y('Â°') },
  });

  // Pioggia (visibile solo se dati presenti)
  const hasPio = gior.some(d => d.pioggia);
  document.getElementById('daily-rain-card').style.display = hasPio ? '' : 'none';
  if (hasPio) {
    mkChart('c-daily-rain','bar',{ labels, datasets:[
      { label:'Pioggia mm', data:gior.map(d=>d.pioggia||0),
        backgroundColor:'#60a5fa55', borderColor:'#60a5fa', borderWidth:1.5, borderRadius:3 },
    ]},{
      ...CHART_DEFAULTS,
      plugins:{ legend:{display:false} },
      scales:{ x:AXIS.x({xticks:{maxTicksLimit:14}}), y:AXIS.y(' mm') },
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkChart(id, type, data, options) {
  if (charts[id]) charts[id].destroy();
  charts[id] = new Chart(document.getElementById(id), { type, data, options });
}

function nav(name, btn) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('s-'+name).classList.add('active');
  btn.classList.add('active');
  // render lazy: solo la prima volta che la sezione diventa visibile
  if (!rendered[name]) {
    if (name === 'anno') renderAnno();
    else if (name === 'periodo') setPeriod(3, document.querySelector('#period-presets .sel-btn[data-days="3"]'));
    else if (name === 'giornaliero') renderGiornaliero();
    rendered[name] = true;
  }
}

// â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();
</script>
</body>
</html>
